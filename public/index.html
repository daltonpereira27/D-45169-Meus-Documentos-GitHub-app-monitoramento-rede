<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Monitoramento de Rede</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div id="connection-status" class="p-2 text-center text-white font-semibold bg-yellow-600 transition-colors duration-500">
        Conectando ao servidor...
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Dashboard de Monitoramento de Rede</h1>
            <p class="text-gray-400 mt-2">Registre e acompanhe as ocorrências da sua infraestrutura de rede.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Coluna de Ações (Formulários) -->
            <div class="lg:col-span-1 space-y-8">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 id="form-title" class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2 text-white">Registrar Ocorrência</h2>
                    <form id="report-form" class="space-y-4">
                        <input type="hidden" id="report-id">
                        <div>
                            <label for="report-date" class="block text-sm font-medium text-gray-300 mb-1">Data</label>
                            <input type="date" id="report-date" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-2">
                        </div>
                        <div>
                            <label for="location-select" class="block text-sm font-medium text-gray-300 mb-1">Local</label>
                            <select id="location-select" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-2">
                                <option>Carregando locais...</option>
                            </select>
                        </div>
                        <div>
                            <label for="incident-select" class="block text-sm font-medium text-gray-300 mb-1">Tipo de Incidente</label>
                            <select id="incident-select" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-2"></select>
                        </div>
                        <div id="custom-description-wrapper" class="hidden">
                             <label for="report-description" class="block text-sm font-medium text-gray-300 mb-1">Descrição Customizada</label>
                            <textarea id="report-description" rows="3" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-2" placeholder="Descreva o incidente..."></textarea>
                        </div>
                        <div>
                            <label for="report-comments" class="block text-sm font-medium text-gray-300 mb-1">Comentários (Opcional)</label>
                            <textarea id="report-comments" rows="3" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-2" placeholder="Adicione observações..."></textarea>
                        </div>
                        <div id="report-form-message" class="text-red-400 text-sm hidden"></div>
                        <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg">Adicionar Relatório</button>
                    </form>
                </div>
            </div>

            <!-- Coluna de Dashboard e Relatórios -->
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Dashboard de Incidências por Local</h2>
                    <div id="incidents-chart" class="space-y-4"></div>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-white">Relatórios Recentes</h2>
                    <div id="reports-list" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Referências aos elementos do DOM
            const connectionStatus = document.getElementById('connection-status');
            const locationSelect = document.getElementById('location-select');
            const reportForm = document.getElementById('report-form');
            const reportsList = document.getElementById('reports-list');
            const incidentSelect = document.getElementById('incident-select');
            const customDescriptionWrapper = document.getElementById('custom-description-wrapper');
            const reportFormMessage = document.getElementById('report-form-message');
            const incidentsChartEl = document.getElementById('incidents-chart');

            let isConnected = false;

            const predefinedIncidents = [
                "INDISPONIBILIDADE DO LINK PRINCIPAL DE INTERNET", "FALHA NO BACKBONE - OPERADORA PARA O TJAP",
                "ROMPIMENTO DE FIBRA OPTICA, AFETANDO UMA UNIDADE", "ROMPIMENTO DE FIBRA OPTICA, AFETANDO MAIS DE UMA UNIDADE",
                "FALHA NA COMUNICAÇÃO EM RAZAO DE TRAVAMENTO OU QUEIMA DE EQUIPAMENTOS TJAP",
                "FALHA NA COMUNICACAO EM RAZAO DE FALTA DE ENERGIA", "LENTIDÃO DO LINK PRINCIPAL DE INTERNET", "Outro"
            ];

            async function fetchData(path) {
                try {
                    const response = await fetch(path);
                    if (!response.ok) {
                        throw new Error(`Erro de rede: ${response.status} - ${response.statusText}`);
                    }
                    if (!isConnected) {
                        connectionStatus.textContent = 'Conectado';
                        connectionStatus.className = 'p-2 text-center text-white font-semibold bg-green-600 transition-colors duration-500';
                        isConnected = true;
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Erro ao buscar dados de ${path}:`, error);
                    if (!isConnected) {
                        connectionStatus.textContent = `Falha na Conexão. Detalhe: ${error.message}. Verifique a configuração do Proxy Reverso (NPM) e os logs dos containers.`;
                        connectionStatus.className = 'p-2 text-center text-white font-semibold bg-red-600 transition-colors duration-500';
                    }
                    throw error;
                }
            }

            async function postData(path, data) {
                 try {
                    const response = await fetch(path, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) {
                        throw new Error(`Erro de rede: ${response.status} - ${response.statusText}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Erro ao enviar dados para ${path}:`, error);
                    reportFormMessage.textContent = 'Falha ao enviar dados para o servidor.';
                    reportFormMessage.classList.remove('hidden');
                    throw error;
                }
            }
            
            async function loadInitialData() {
                try {
                    const [locations, reports] = await Promise.all([
                        fetchData('/api/locations'),
                        fetchData('/api/reports')
                    ]);
                    
                    updateLocationDropdown(locations);
                    renderReports(reports);
                    updateDashboard(reports);

                } catch (error) {
                    console.log("Não foi possível carregar os dados iniciais devido a um erro de conexão.");
                }
            }
            
            function updateLocationDropdown(locations) {
                locationSelect.innerHTML = '';
                if (locations.length === 0) {
                    locationSelect.innerHTML = '<option disabled selected>Cadastre um local primeiro</option>';
                } else {
                    locations.forEach(location => {
                        const option = document.createElement('option');
                        option.value = location.name;
                        option.textContent = location.name;
                        locationSelect.appendChild(option);
                    });
                }
            }
            
            function renderReports(reports) {
                reportsList.innerHTML = '';
                if (reports.length === 0) {
                    reportsList.innerHTML = '<p class="text-gray-500 text-sm">Nenhum relatório registrado.</p>';
                    return;
                }
                reports.forEach(report => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-700 p-4 rounded-lg';
                    const formattedDate = new Date(report.report_date).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                    div.innerHTML = `
                        <p class="font-bold text-cyan-400">${report.location}</p>
                        <p class="text-sm text-gray-400">${formattedDate}</p>
                        <p class="mt-2 text-gray-200">${report.description}</p>
                        ${report.comments ? `<p class="mt-2 text-sm text-gray-300 italic"><strong>Comentário:</strong> ${report.comments}</p>` : ''}
                    `;
                    reportsList.appendChild(div);
                });
            }

            reportForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                let description = incidentSelect.value;
                if (description === 'Outro') {
                    description = document.getElementById('report-description').value.trim();
                }

                const reportData = {
                    report_date: document.getElementById('report-date').value,
                    location: locationSelect.value,
                    description: description,
                    comments: document.getElementById('report-comments').value.trim(),
                };

                if (!reportData.report_date || !reportData.location || !reportData.description) {
                    reportFormMessage.textContent = 'Data, Local e Tipo de Incidente são obrigatórios.';
                    reportFormMessage.classList.remove('hidden');
                    return;
                }
                
                try {
                    await postData('/api/reports', reportData);
                    reportForm.reset();
                    setDefaultDate();
                    loadInitialData();
                    reportFormMessage.classList.add('hidden');
                } catch (error) {
                    // A mensagem de erro já é tratada em postData
                }
            });

            function updateDashboard(reports) {
                incidentsChartEl.innerHTML = '';
                if (reports.length === 0) {
                    incidentsChartEl.innerHTML = '<p class="text-gray-500 text-sm">Sem dados para exibir.</p>';
                    return;
                }
                const incidentsByLocation = reports.reduce((acc, report) => {
                    acc[report.location] = (acc[report.location] || 0) + 1;
                    return acc;
                }, {});
                
                Object.entries(incidentsByLocation).forEach(([location, count]) => {
                    const barElement = document.createElement('div');
                    barElement.innerHTML = `<div class="flex justify-between items-center"><span class="text-sm">${location}</span><span class="text-sm font-bold">${count}</span></div>`;
                    incidentsChartEl.appendChild(barElement);
                });
            }
            
            function setDefaultDate() {
                document.getElementById('report-date').value = new Date().toISOString().split('T')[0];
            }
            
            function populateIncidentSelect() {
                predefinedIncidents.forEach(incident => {
                    const option = document.createElement('option');
                    option.value = incident;
                    option.textContent = incident;
                    incidentSelect.appendChild(option);
                });
            }

            incidentSelect.addEventListener('change', (e) => {
                customDescriptionWrapper.classList.toggle('hidden', e.target.value !== 'Outro');
            });
            
            setDefaultDate();
            populateIncidentSelect();
            loadInitialData();
        });
    </script>
</body>
</html>
